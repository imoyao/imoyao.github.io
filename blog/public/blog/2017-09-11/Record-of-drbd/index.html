<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="这是一个关于 DRBD 的使用备忘录。">
<meta name="keywords" content="DRBD,存储,集群">
<meta property="og:type" content="article">
<meta property="og:title" content="DRBD备忘记录">
<meta property="og:url" content="https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/index.html">
<meta property="og:site_name" content="别院牧志">
<meta property="og:description" content="这是一个关于 DRBD 的使用备忘录。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://docs.linbit.com/ug-src/users-guide-8.4/images/drbd-in-kernel.png">
<meta property="og:updated_time" content="2019-06-07T02:03:22.573Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DRBD备忘记录">
<meta name="twitter:description" content="这是一个关于 DRBD 的使用备忘录。">
<meta name="twitter:image" content="https://docs.linbit.com/ug-src/users-guide-8.4/images/drbd-in-kernel.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>DRBD备忘记录</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/blog/2017-11-11/choose-fo-or-gril/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&text=DRBD备忘记录"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&is_video=false&description=DRBD备忘记录"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DRBD备忘记录&body=Check out this article: https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&name=DRBD备忘记录&description=&lt;p&gt;这是一个关于 &lt;code&gt;DRBD&lt;/code&gt; 的使用备忘录。&lt;br&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#drbd状态记录"><span class="toc-number">1.</span> <span class="toc-text">drbd状态记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#清除单个-DRBD-资源配置：-以drbd10为例"><span class="toc-number">2.</span> <span class="toc-text">清除单个 DRBD 资源配置：(以drbd10为例)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重启-DRBD-服务"><span class="toc-number">3.</span> <span class="toc-text">重启 DRBD 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DRBD扩容"><span class="toc-number">4.</span> <span class="toc-text">DRBD扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流程简单示例"><span class="toc-number">4.1.</span> <span class="toc-text">流程简单示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#global-common-conf配置（示例）"><span class="toc-number">5.</span> <span class="toc-text">global_common.conf配置（示例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据同步协议"><span class="toc-number">5.1.</span> <span class="toc-text">数据同步协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单个drbd配置文件（以drbd10-res-为例）"><span class="toc-number">6.</span> <span class="toc-text">单个drbd配置文件（以drbd10.res 为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目中的配置方案"><span class="toc-number">6.1.</span> <span class="toc-text">项目中的配置方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#另外一种配置方案"><span class="toc-number">6.2.</span> <span class="toc-text">另外一种配置方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主从切换"><span class="toc-number">7.</span> <span class="toc-text">主从切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正常切换"><span class="toc-number">7.1.</span> <span class="toc-text">正常切换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#主端"><span class="toc-number">7.1.1.</span> <span class="toc-text">主端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从端"><span class="toc-number">7.1.2.</span> <span class="toc-text">从端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#停止drbd服务切换"><span class="toc-number">7.2.</span> <span class="toc-text">停止drbd服务切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#脑裂修复"><span class="toc-number">8.</span> <span class="toc-text">脑裂修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-number">9.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#双控配置互信（假定在控1执行）"><span class="toc-number">9.1.</span> <span class="toc-text">双控配置互信（假定在控1执行）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考阅读"><span class="toc-number">10.</span> <span class="toc-text">参考阅读</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        DRBD备忘记录
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">别院牧志</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-09-11T09:56:38.000Z" itemprop="datePublished">2017-09-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/教程记录/">教程记录</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/DRBD/">DRBD</a>, <a class="tag-link" href="/tags/存储/">存储</a>, <a class="tag-link" href="/tags/集群/">集群</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <script src="/assets/js/APlayer.min.js"> </script><p>这是一个关于 <code>DRBD</code> 的使用备忘录。<br><a id="more"></a></p>
<p><img src="https://docs.linbit.com/ug-src/users-guide-8.4/images/drbd-in-kernel.png" alt="DRBD在Linux内核I/O栈的位置"></p>
<p>开始阅读之前，请先注意示例中使用的DRBD版本</p>
<pre><code class="shell">drbdadm -V
# DRBDADM_VERSION=8.4.3
</code></pre>
<p>注意：安装的kernel-devel的内核源码（内核源码路径/usr/src/kernel/）和当前系统的kernel版本(uname -r)不一致的话需要把当前内核更新一下。<br>在<code>2.6.33</code>及以上版本的内核默认中有<code>DRBD</code>,之前在用的<code>DRBD</code>主要<code>8.0</code>、<code>8.2</code>、<code>8.3</code> 三个版本,对应的<code>rpm</code>包是<code>drbd</code>,<code>drbd82</code>和<code>drbd83</code>，因此需要安装对应的内核模块，对应的名字为<code>kmod-drbd</code>,<code>kmod-drbd82</code>,<code>kmod-drbd83</code>。<br>由于<code>drbd</code>是作为内核模块进行工作的，故建议使用与内核对应的版本，对应关系如下表。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Linux releases</th>
<th style="text-align:left">DRBD releases</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">2.6.33</td>
<td style="text-align:left">8.3.7</td>
</tr>
<tr>
<td style="text-align:left">2.6.34</td>
<td style="text-align:left">8.3.7</td>
</tr>
<tr>
<td style="text-align:left">2.6.35</td>
<td style="text-align:left">8.3.8</td>
</tr>
<tr>
<td style="text-align:left">2.6.36</td>
<td style="text-align:left">8.3.8.1</td>
</tr>
<tr>
<td style="text-align:left">2.6.37</td>
<td style="text-align:left">8.3.9</td>
</tr>
<tr>
<td style="text-align:left">2.6.38</td>
<td style="text-align:left">8.3.9</td>
</tr>
<tr>
<td style="text-align:left">2.6.39</td>
<td style="text-align:left">8.3.10</td>
</tr>
<tr>
<td style="text-align:left">3.0 - 3.4</td>
<td style="text-align:left">8.3.11</td>
</tr>
<tr>
<td style="text-align:left">3.5 - 3.7</td>
<td style="text-align:left">8.3.13</td>
</tr>
</tbody>
</table>
<p><strong>注意:</strong>目前官网上面8.0 – 8.3.x已标注为<code>Deprecated</code>即不建议使用状态。</p>
<h2 id="drbd状态记录"><a href="#drbd状态记录" class="headerlink" title="drbd状态记录"></a>drbd状态记录</h2><p><a href>本部分内容详见此处</a></p>
<h2 id="清除单个-DRBD-资源配置：-以drbd10为例"><a href="#清除单个-DRBD-资源配置：-以drbd10为例" class="headerlink" title="清除单个 DRBD 资源配置：(以drbd10为例)"></a>清除单个 <code>DRBD</code> 资源配置：(以drbd10为例)</h2><pre><code class="shell">drbd-overview       # drbd概览
drbdadm down drbd10         #down drbd
echo yes|drbdadm wipe-md drbd10     #清除metadata
cd /etc/drbd.d/         # 注意，此处根据drbd版本不同也可能在/usr/local/etc/drbd.d/
rm drbd10.res           #删除resource文件
</code></pre>
<h2 id="重启-DRBD-服务"><a href="#重启-DRBD-服务" class="headerlink" title="重启 DRBD 服务"></a>重启 <code>DRBD</code> 服务</h2><pre><code class="shell">service drbd stop 
service drbd start 
</code></pre>
<h2 id="DRBD扩容"><a href="#DRBD扩容" class="headerlink" title="DRBD扩容"></a><code>DRBD</code>扩容</h2><p>当遇到我们的<code>drbd resource</code>设备容量不够的时候，而且我们的底层设备支持在线增大容量的时候（比如lvm），我们可以先增大底层设备的大小，然后再通过<code>drbdadm resize resource_name</code>来实现对<code>resource</code>的扩容。<br>这里有需要注意的是：<br>只有在单主模式下可以这样做，而且需要先在两节点上都增大底层设备的容量，然后仅在主节点上执行<code>resize</code>命令。</p>
<p>在执行了<code>resize</code>命令后，将自动触发一次当前主节点到其他所有从节点的re-synchronization；</p>
<p>如果我们在<code>drbd</code>非工作状态下对底层设备进行了扩容，然后再启动<code>drbd</code>，将不需要执行<code>resize</code>命令（当然前提是在配置文件中没有对disk参数项指定大小），<code>drbd</code>自己会知道已经增大了容量；</p>
<p>在进行底层设备的增容操作的时候千万不要修改到原设备上面的数据，尤其是<code>drbd</code>的<code>meta</code>信息，否则有可能毁掉所有数据。</p>
<h3 id="流程简单示例"><a href="#流程简单示例" class="headerlink" title="流程简单示例"></a>流程简单示例</h3><pre><code class="shell"># 先在两端扩展Lun（需要相同大小）     
lvextend -Ll(50G) lvpath

# drbd从端：（双主模式切换为主从模式）
drbdadm secondary drbd[Num]     

# drbd主端：
drbdadm resize drbd[Num]
</code></pre>
<h2 id="global-common-conf配置（示例）"><a href="#global-common-conf配置（示例）" class="headerlink" title="global_common.conf配置（示例）"></a>global_common.conf配置（示例）</h2><pre><code class="shell">global {
    usage-count no;     # 是否向官方发送统计报告（影响性能）
}
common {            # 定义drbd设备共享的属性信息
    handlers {
    }
    startup {       # 启动时候的相关设置
        wfc-timeout 50;
        become-primary-on both;     # 允许双主
    }

    disk {
        on-io-error detach;     # 配置I/O错误处理策略为分离
        no-disk-flushes ;
        no-disk-barrier;
        c-plan-ahead 0;
        c-fill-target 24M;
        c-min-rate 80M;
        c-max-rate 720M;
    } 
    net {               # 网络配置相关
        protocol C;     # 同步异步控制（见下方介绍）
        after-sb-0pri discard-younger-primary;  # 脑裂修复
        after-sb-1pri discard-secondary;
        after-sb-2pri call-pri-lost-after-sb;
        allow-two-primaries yes;        # 允许双主
        max-buffers        36k;
        sndbuf-size         1024k ;
        rcvbuf-size      2048k;
    }
    syncer {    # 同步相关的设置
            rate                   4194304k;    # bytes/second
            al-extents              6433;
    }
}
# Read_More:http://tech.sina.com.cn/smb/2008-12-22/1050926302.shtml

</code></pre>
<h3 id="数据同步协议"><a href="#数据同步协议" class="headerlink" title="数据同步协议"></a>数据同步协议</h3><p><code>DRBD</code>有三种数据同步模式:同步，异步，半同步</p>
<ol>
<li>异步：指的是当数据写到磁盘上，并且复制的数据已经被放到我们的<code>tcp</code>缓冲区并等待发送以后，就认为写入完成；</li>
<li>半同步：指的是数据已经写到磁盘上，并且这些数据已经发送到对方内存缓冲区，对方的<code>tcp</code>已经收到数据，并宣布写入；</li>
<li>同步：指的是主节点已写入，从节点磁盘也写入；</li>
</ol>
<p><code>DRBD</code>的复制模型是靠<code>protocol</code>关键字来定义的：<code>protocol A</code>表示异步；<code>protocol B</code>表示半同步；<code>protocol C</code>表示同步，默认为<code>protocol C</code>。</p>
<p>在同步模式下只有主、从节点上两块磁盘同时损害才会导致数据丢失。在半同步模式下只有主节点宕机，同时从节点异常停电才会导致数据丢失。</p>
<p><strong>注意:</strong></p>
<ol>
<li>主从所在的磁盘分区最好大小相等,<code>DRBD</code>磁盘镜像相当于网络<code>RAID1</code>；（本人使用时强制相等，但网上没有关于分区大小是否一定要相同的确切说法）</li>
<li>网络同步时需要一定的时间，在同步完成之前最好不要重启，否则会重新同步；</li>
<li><code>DRBD</code>的主节点不会监控从节点的状态，所以有可能会造成数据重传；</li>
<li>格式化只需要在<code>primary</code>节点上进行,且只能在主节点上挂载；若主节点下线,从节点上线,则从节点可以直接挂载,不需要再次格式化。集群中只有primary服务器可以挂载设备，secondary挂载会报错。只有在进行故障迁移升级为主时才需要挂载。</li>
<li>如果<code>DRBD</code>状态下关机双控恢复不过来，尝试删除<code>DRBD</code>配置信息，然后停掉<code>DRBD</code>端ODSP和<code>mysql</code>重启之后即可；(此条仅针对公司项目)</li>
</ol>
<h2 id="单个drbd配置文件（以drbd10-res-为例）"><a href="#单个drbd配置文件（以drbd10-res-为例）" class="headerlink" title="单个drbd配置文件（以drbd10.res 为例）"></a>单个<code>drbd</code>配置文件（以drbd10.res 为例）</h2><h3 id="项目中的配置方案"><a href="#项目中的配置方案" class="headerlink" title="项目中的配置方案"></a>项目中的配置方案</h3><pre><code class="shell">resource drbd11 {
    on controller-1 {
        device /dev/drbd11;
        disk /dev/StorPool11/SANLun11;
        address 192.168.2.10:57811;
        meta-disk internal;
    }
    on controller-2 {
        device /dev/drbd11;
        disk /dev/StorPool11/SANLun11;
        address 192.168.2.18:57811;
        meta-disk internal;
    }
}
</code></pre>
<h3 id="另外一种配置方案"><a href="#另外一种配置方案" class="headerlink" title="另外一种配置方案"></a>另外一种配置方案</h3><p>来自<a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_drbd_configure.html" target="_blank" rel="noopener">这里</a></p>
<pre><code class="shell">resource r0 {   # ①
  device /dev/drbd0; # ②
  disk /dev/sda1;   # ③
  meta-disk internal;   # ④
  on alice {    # ⑤
    address  192.168.1.10:7788;     # ⑥
  }
  on bob { 
    address 192.168.1.11:7788; 
  }
  syncer {
    rate  7M;   # ⑦
  }
}
</code></pre>
<p>翻译以看懂为目的：</p>
<p>1.允许某些系统服务项关联的名称，如：nfs, http, mysql_0, postgres_wal等；<br>Name that allows some association to the service that needs them. For example, nfs, http, mysql_0, postgres_wal, etc.</p>
<p>2.<code>DRBD</code>设备名称及编号；<br>The device name for DRBD and its minor number.</p>
<p>在上面的例子中，<code>drbd</code>的编号是<code>0</code>。udev集成脚本提供符号链接<code>/dev/drbd/by-res/nfs/0</code>。或者，也可以省略配置中的设备节点名称，然后使用下面这种形式代替：<br><code>drbd0 minor 0</code>（/dev/可选）或<code>/dev/drbd0</code>；</p>
<p>In the example above, the minor number 0 is used for DRBD. The udev integration scripts will give you a symbolic link /dev/drbd/by-res/nfs/0. Alternatively, omit the device node name in the configuration and use the following line instead:<br>drbd0 minor 0 (/dev/ is optional) or /dev/drbd0</p>
<p>3.节点之间进行复制的原始设备。注意：在本例中，两个节点上面的设备是相同的。若使用不同设备，请将磁盘参数移动到主机上。（？）</p>
<p>The raw device that is replicated between nodes. Note, in this example the devices are the same on both nodes. If you need different devices, move the disk parameter into the on host.</p>
<p>4.<code>meta-disk</code>参数通常包含隐式值，但是你也可以指定一个显式设备保存元数据。详情参见：<a href="http://www.drbd.org/users-guide-emb/ch-internals.html#s-metadata" target="_blank" rel="noopener">这里&gt;&gt;&gt;</a></p>
<p>The meta-disk parameter usually contains the value internal, but it is possible to specify an explicit device to hold the meta data. See <a href="http://www.drbd.org/users-guide-emb/ch-internals.html#s-metadata" target="_blank" rel="noopener">http://www.drbd.org/users-guide-emb/ch-internals.html#s-metadata</a> for more information.</p>
<p>5.<code>on</code>节配置指明改配置应用于具体哪个<code>host</code>。</p>
<p>The on section states which host this configuration statement applies to.</p>
<p>6.各节点的<code>IP</code>地址和端口号。每个资源需要一个单独的端口，通常以<code>7788</code>开始。</p>
<p>The IP address and port number of the respective node. Each resource needs an individual port, usually starting with 7788.</p>
<p>7.同步率。将其设置为磁盘读写和网络带宽的三分之一。仅限制重新同步，而不是复制。</p>
<p>The synchronization rate. Set it to one third of the lower of the disk- and network bandwidth. It only limits the resynchronization, not the replication.</p>
<h2 id="主从切换"><a href="#主从切换" class="headerlink" title="主从切换"></a>主从切换</h2><p>主备节点切换有两种方式，分别是停止<code>DRBD</code>服务切换和正常切换。</p>
<h3 id="正常切换"><a href="#正常切换" class="headerlink" title="正常切换"></a>正常切换</h3><p>主切换成从，需要先卸载文件系统，再执行降级为从的命令</p>
<h4 id="主端"><a href="#主端" class="headerlink" title="主端"></a>主端</h4><pre><code class="shell">umount /data/
drbdadm secondary all
</code></pre>
<h4 id="从端"><a href="#从端" class="headerlink" title="从端"></a>从端</h4><p>从切换成主，要先执行升主的命令，然后挂载文件系统</p>
<pre><code class="shell">drbdadm  primary all
mount /dev/drbd0 /data/
</code></pre>
<h3 id="停止drbd服务切换"><a href="#停止drbd服务切换" class="headerlink" title="停止drbd服务切换"></a>停止drbd服务切换</h3><p>基本思路：关闭主节点服务，此时挂载的<code>DRBD</code>分区就自动在主节点卸载了，然后在备用节点执行切换命令</p>
<pre><code class="shell">[root@drbd2 ~]#drbdadm primary all
# 此时报错：
2: State change failed: (-7) Refusing to be Primary while peer is not outdated
Command &#39;drbdsetup 2 primary&#39; terminated with exit code 11
# 因此，必须在备用节点执行如下命令：
[root@drbd2 ~]#drbdsetup /dev/drbd0 primary –o
# 或者
[root@drbd2~]#drbdadm -- --overwrite-data-of-peer primary all
</code></pre>
<p>当在备用节点执行切换到主节点命令后，原来的主用节点自动变为备用节点。无需在主用节点再次执行切换到备用节点的命令。</p>
<h2 id="脑裂修复"><a href="#脑裂修复" class="headerlink" title="脑裂修复"></a>脑裂修复</h2><p>当<code>DRBD</code>出现脑裂后，会导致<code>DRBD</code>两边的磁盘数据不一致，在确定要作为从的节点上切换成<code>secondary</code>，并放弃该资源的数据:</p>
<pre><code class="shell">drbdadm secondary r0
drbdadm -- --discard-my-data connect r0
</code></pre>
<p>然后作为<code>primary</code>的节点重新连接<code>secondary</code>（如果这个节点当前的连接状态为<code>WFConnection</code>的话，可以省略），使用如下命令连接：</p>
<pre><code class="shell">drbdadm connect r0
</code></pre>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="双控配置互信（假定在控1执行）"><a href="#双控配置互信（假定在控1执行）" class="headerlink" title="双控配置互信（假定在控1执行）"></a>双控配置互信（假定在控1执行）</h3><pre><code class="shell">echo y|ssh-keygen -t dsa -f ~/.ssh/id_dsa -N &quot;&quot;
cp ~/.ssh/id_dsa.pub ~/.ssh/authorized_keys
scp -r ~/.ssh controller-2:         #双控对端hostname
</code></pre>
<h2 id="参考阅读"><a href="#参考阅读" class="headerlink" title="参考阅读"></a>参考阅读</h2><ul>
<li><p><a href="https://docs.linbit.com/docs/users-guide-8.4/" target="_blank" rel="noopener">官方手册</a></p>
</li>
<li><p><a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/cha_ha_drbd.html" target="_blank" rel="noopener">SUSE高可用配置</a></p>
</li>
<li><p><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Clusters_from_Scratch/ch07.html" target="_blank" rel="noopener">使用DRBD实现复制存储</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/wxl-dede/p/5114696.html" target="_blank" rel="noopener">drbd 配置 - Rikewang - 博客园</a></p>
</li>
<li><p><a href="http://www.3mu.me/centos%E4%B8%8B%E5%AE%9E%E7%8E%B0heartbeatdrbdmysql%E5%8F%8C%E6%9C%BA%E7%83%AD%E5%A4%87%E7%A1%AC%E4%BB%B6%E6%95%85%E9%9A%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%E9%AB%98%E5%8F%AF%E7%94%A8ha/#respond" target="_blank" rel="noopener">CentOS下实现Heartbeat+DRBD+MySQL双机热备硬件故障自动切换高可用(HA)方案 | 三木的人生——3mu.me</a></p>
</li>
<li><p><a href="https://www.ibm.com/developerworks/library/l-drbd/index.html" target="_blank" rel="noopener">High availability with the Distributed Replicated Block Device</a></p>
</li>
<li><p><a href="https://yq.aliyun.com/articles/52043" target="_blank" rel="noopener">记一次DRBD Unknown故障处理过程</a></p>
</li>
<li><p><a href="https://www.linuxidc.com/wap.aspx?nid=93422&amp;cid=9&amp;sp=654" target="_blank" rel="noopener">DRBD 管理、故障处理部分</a>(<a href="https://www.linuxidc.com/Linux/2013-12/93422.htm" target="_blank" rel="noopener">https://www.linuxidc.com/Linux/2013-12/93422.htm</a>)</p>
</li>
<li><p><a href="http://blog.csdn.net/t1anyuan/article/details/52143789" target="_blank" rel="noopener">DRBD编译安装中出现的问题及解决小结 - CSDN博客</a></p>
</li>
<li><p><a href="https://www.linuxidc.com/Linux/2012-01/51661.htm" target="_blank" rel="noopener">DRBD配置参数</a></p>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#drbd状态记录"><span class="toc-number">1.</span> <span class="toc-text">drbd状态记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#清除单个-DRBD-资源配置：-以drbd10为例"><span class="toc-number">2.</span> <span class="toc-text">清除单个 DRBD 资源配置：(以drbd10为例)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重启-DRBD-服务"><span class="toc-number">3.</span> <span class="toc-text">重启 DRBD 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DRBD扩容"><span class="toc-number">4.</span> <span class="toc-text">DRBD扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#流程简单示例"><span class="toc-number">4.1.</span> <span class="toc-text">流程简单示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#global-common-conf配置（示例）"><span class="toc-number">5.</span> <span class="toc-text">global_common.conf配置（示例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据同步协议"><span class="toc-number">5.1.</span> <span class="toc-text">数据同步协议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单个drbd配置文件（以drbd10-res-为例）"><span class="toc-number">6.</span> <span class="toc-text">单个drbd配置文件（以drbd10.res 为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目中的配置方案"><span class="toc-number">6.1.</span> <span class="toc-text">项目中的配置方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#另外一种配置方案"><span class="toc-number">6.2.</span> <span class="toc-text">另外一种配置方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主从切换"><span class="toc-number">7.</span> <span class="toc-text">主从切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正常切换"><span class="toc-number">7.1.</span> <span class="toc-text">正常切换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#主端"><span class="toc-number">7.1.1.</span> <span class="toc-text">主端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从端"><span class="toc-number">7.1.2.</span> <span class="toc-text">从端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#停止drbd服务切换"><span class="toc-number">7.2.</span> <span class="toc-text">停止drbd服务切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#脑裂修复"><span class="toc-number">8.</span> <span class="toc-text">脑裂修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-number">9.</span> <span class="toc-text">其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#双控配置互信（假定在控1执行）"><span class="toc-number">9.1.</span> <span class="toc-text">双控配置互信（假定在控1执行）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考阅读"><span class="toc-number">10.</span> <span class="toc-text">参考阅读</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&text=DRBD备忘记录"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&is_video=false&description=DRBD备忘记录"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=DRBD备忘记录&body=Check out this article: https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&title=DRBD备忘记录"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://imoyao.github.io/blog/2017-09-11/Record-of-drbd/&name=DRBD备忘记录&description=&lt;p&gt;这是一个关于 &lt;code&gt;DRBD&lt;/code&gt; 的使用备忘录。&lt;br&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 imoyao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
