<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>CentOS7环境下配置DRBD | 别院牧志</title>
  <meta name="author" content="imoyao">
  
  <meta name="description" content="Valar Dohaeris.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="CentOS7环境下配置DRBD"/>
  <meta property="og:site_name" content="别院牧志"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.ico" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/journal.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  
    <script src="/js/marked.js"></script>
    <script src="/js/comment.js"></script>
    <script src="/js/timeago.min.js"></script>
    <script src="/js/highlight.min.js"></script>
	<script src="/js/spin.min.js"></script>
  
  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">别院牧志</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>归档
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于我
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header ">		
			<h1 class="title "> CentOS7环境下配置DRBD</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">
	  		

	  <script src="/assets/js/APlayer.min.js"> </script><p>本文主要记录<code>DRBD</code>的配置过程和功能验证。<br><a id="more"></a></p>
<p>本文使用<code>64</code>位<code>CentOS</code>，基本环境：</p>
<pre><code class="shell">+-----------------------+              |               +----------------------+
| [ DRBD_A (Server#1) ] | 10.10.17.18  |  10.10.17.19  | [DRBD_B (Server#2) ] |
|       node01          +--------------+---------------+         node02       |
|                       |                              |                      |
+-----------------------+                              +----------------------+

DRBD 服务器A ：ip:10.10.17.18，hostname：DRBD_A
DRBD 服务器B ：ip:10.10.17.19，hostname：DRBD_B
</code></pre>
<h2 id="建立磁盘分区"><a href="#建立磁盘分区" class="headerlink" title="建立磁盘分区"></a>建立磁盘分区</h2><ul>
<li>分区之前</li>
</ul>
<pre><code class="shell">[root@DRBD_A ~]# lsblk      # 查询块设备信息
NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
fd0                     2:0    1    4K  0 disk
sda                     8:0    0   16G  0 disk
├─sda1                  8:1    0  500M  0 part /boot
└─sda2                  8:2    0 15.5G  0 part
  ├─centos_bogon-root 253:0    0 13.9G  0 lvm  /
  └─centos_bogon-swap 253:1    0  1.6G  0 lvm  [SWAP]
sdb                     8:16   0    5G  0 disk
└─StorPool-SANLun10   253:2    0    2G  0 lvm
sr0                    11:0    1 1024M  0 rom
drbd0                 147:0    0    2G  1 disk
</code></pre>
<ul>
<li>进行分区</li>
</ul>
<pre><code class="shell">[root@DRBD_A ~]# fdisk /dev/sdb     # 在sdb上新建分区
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0xb25d5d26.

Command (m for help): n         #  新建
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p):
Using default response p
Partition number (1-4, default 1):
First sector (2048-10485759, default 2048):
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-10485759, default 10485759): +1G
Partition 1 of type Linux and of size 1 GiB is set

Command (m for help): w         #  写入
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre>
<ul>
<li>分区之后</li>
</ul>
<pre><code class="shell">[root@DRBD_A ~]# lsblk
NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
fd0                     2:0    1    4K  0 disk
sda                     8:0    0   16G  0 disk
├─sda1                  8:1    0  500M  0 part /boot
└─sda2                  8:2    0 15.5G  0 part
  ├─centos_bogon-root 253:0    0 13.9G  0 lvm  /
  └─centos_bogon-swap 253:1    0  1.6G  0 lvm  [SWAP]
sdb                     8:16   0    5G  0 disk
├─sdb1                  8:17   0    1G  0 part      # 新分区
└─StorPool-SANLun10   253:2    0    2G  0 lvm
sr0                    11:0    1 1024M  0 rom
drbd0                 147:0    0    2G  0 disk /media
</code></pre>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><h3 id="更改DRBD全局配置"><a href="#更改DRBD全局配置" class="headerlink" title="更改DRBD全局配置"></a>更改DRBD全局配置</h3><p>首先根据需求更改<code>DRBD</code>全局配置<code>/etc/drbd.d/global_common.conf</code>:</p>
<p>此处可参阅另一篇文章：<a href="https://imoyao.github.io/blog/2017-09-11/Record_of_drbd/#global-common-conf配置（示例）">DRBD全局配置</a></p>
<h3 id="创建DRBD配置文件"><a href="#创建DRBD配置文件" class="headerlink" title="创建DRBD配置文件"></a>创建<code>DRBD</code>配置文件</h3><p>由于<code>DRBD</code>是基于块设备的存储复制解决方案，所以此处使用<code>Lun</code>作为演示。</p>
<pre><code class="shell">vi r0.res
resource r0 {
    # DRBD device
    device /dev/drbd0;
    # block device
    disk /dev/StorPool/SANLun10;    # 磁盘路径，若为disk则修改为/dev/sdb1
    meta-disk internal;
    on DRBD_A {
        # IP address:port
        address 10.10.17.18:7788;
    }
    on DRBD_B {
        address 10.10.17.19:7788;
    }
}
</code></pre>
<p><code>注意：</code>本机主机名(<code>hostname</code>)和地址(<code>ip</code>)必须严格按照真实情况配置，两边<code>.res</code>文件内容尽量保持一致。</p>
<p>配置文件创建完成之后，在两个服务器上分别执行如下命令，创建<code>DRBD</code>资源，当然你也可以通过<code>scp</code>把配置文件拷过去，然后执行相关命令。</p>
<p>其中上述配置文件的meta-disk有三种记录方式：internal/device/device[index_num]。其中不管是哪种方式，metadata存放的分区不能格式化，哪怕使用internal时metadata和一般data在同一个分区也不能格式化该分区。</p>
<p>internal是将元数据也写入到数据分区的尾部，即数据和元数据同分区。如果指定的device没有给定index时，则表示元数据存储到该设备中。如果某节点指定device[index_num]，那么指定几次元数据分区索引就必须大于128M的几倍，例如上述文件中drbd1.longshuai.com节点指定了/dev/sdb1[0]，那么sdb1就必须大于128M，如果此时其他资源的节点也指定了同一台服务器的/dev/sdb1[1]，则指定了两次就必须大于256M。指定为internal和device时，元数据区的大小是drbd自行计算的。<br>上面index的说法来自<a href="http://www.cnblogs.com/f-ck-need-u/p/8678883.html#1-drbd-" target="_blank" rel="noopener">这里</a>，具体没有实际验证。</p>
<pre><code class="shell">drbdadm create-md r0
</code></pre>
<p>然后启动DRBD：</p>
<pre><code class="shell">drbdadm up r0
</code></pre>
<p>我在测试时没有操作下一步操作，但是数据也可以完成同步。查询了一下，网上说<code>drbdadm up</code>这个命令相当于<code>attach</code>、<code>syncer</code>、<code>connect</code>的总集合。但是后台使用<code>systemctl status drbd</code>获取到的状态还是<code>inactive (dead)</code>，欢迎大家提出自己的看法。</p>
<hr>
<p>在两个服务器上分别启动<code>DRBD</code>服务：</p>
<pre><code class="shell">/etc/init.d/drbd start
</code></pre>
<hr>
<p>把<code>DRBD_A</code>做为主服务器：</p>
<pre><code class="shell"># 无数据时
drbdadm primary r0
# 有数据时，把本端作为primary端，本地数据分发到其他节点。
drbdadm -- --overwrite-data-of-peer primary r0
</code></pre>
<p>使用如下命令查看<code>DRBD</code>服务的状态信息：</p>
<pre><code class="shell">/etc/init.d/drbd status
#或者
drbd-overview
</code></pre>
<p>此时，写入<code>DRBD_A</code>端(<code>/dev/drbd1</code>)的数据都会同步到<code>DRBD_B</code>端。</p>
<h2 id="测试数据同步"><a href="#测试数据同步" class="headerlink" title="测试数据同步"></a>测试数据同步</h2><h3 id="Primary端"><a href="#Primary端" class="headerlink" title="Primary端"></a><code>Primary</code>端</h3><ul>
<li>格式化<code>drbd</code></li>
</ul>
<pre><code class="shell">mkfs.xfs /dev/drbd0
</code></pre>
<ul>
<li>挂载设备</li>
</ul>
<pre><code class="shell">mount /dev/drbd0 /media
</code></pre>
<ul>
<li>写入数据</li>
</ul>
<pre><code class="shell">cd /media/
mkdir drbd_test
cd drbd_test/
echo &quot;hello World&quot; &gt; hello.txt
</code></pre>
<ul>
<li>卸载设备</li>
</ul>
<pre><code class="shell">cd ~
umount /media
</code></pre>
<ul>
<li>本端降级</li>
</ul>
<pre><code class="shell">drbdadm secondary r0
</code></pre>
<h3 id="Secondary端"><a href="#Secondary端" class="headerlink" title="Secondary端"></a><code>Secondary</code>端</h3><ul>
<li>从端升主</li>
</ul>
<pre><code class="shell">drbdadm primary r0
</code></pre>
<ul>
<li>挂载设备</li>
</ul>
<pre><code class="shell">mount /dev/drbd0 /media
</code></pre>
<p><strong>注意：</strong> 此时从端不需要再次格式化，否则数据丢失。</p>
<ul>
<li>验证数据</li>
</ul>
<pre><code class="shell">cd /media
ls
cat ./drbd_test/hello.txt
# 返回
hello World
</code></pre>
<p>参考来源</p>
<ul>
<li><a href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=drbd&amp;f=2" target="_blank" rel="noopener">CentOS 7 : DRBD : Configure : Server World</a></li>
</ul>
	  
	</div>

	<!-- recommended posts -->
	

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/blog/2018-01-18/python-env-introduce/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/blog/2018-01-11/how-to-install-drbd-on-CentOS7/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
        <a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a>
        <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
    </div>
    <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};
        with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>


        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>
    	 
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
           type: "github" ? "github" : "github",       
	       user: "imoyao",
	       repo: "imoyao.github.io",
		   client_id: "",
           client_secret: "",
		   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
		   go_to_comment: "去留言",
		   no_issue: "no_issue",
		   issue_title: "CentOS7环境下配置DRBD",
		   issue_id: "",
		   btn_class: "btn btn-primary",
		   comments_target: "#comment-thread",
		   loading_target: "#loading_spin"
		   });
	 </script>
  
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-01-11 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/工作日常/">工作日常<span>4</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/DRBD/">DRBD<span>7</span></a></li> <li><a href="/tags/Linux/">Linux<span>5</span></a></li> <li><a href="/tags/CentOS/">CentOS<span>2</span></a></li>
    </ul>
	</div>
	

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 imoyao
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#" style="text-align: center;line-height: 36px;">
  <i class="fa fa-chevron-up"></i>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->

  <script>
  marked.setOptions({
    highlight: function (code, lang) {
        return hljs.highlightAuto(code).value;
    }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
        if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
  </script>


</body>
   </html>
