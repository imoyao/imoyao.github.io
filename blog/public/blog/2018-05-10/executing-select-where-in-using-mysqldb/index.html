<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>关于在 Python 中 MySQL 的 WHERE 子句中执行 IN 操作（list，tuple）的问题 | 别院牧志</title>
  <meta name="author" content="imoyao">
  
  <meta name="description" content="Valar Dohaeris.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="关于在 Python 中 MySQL 的 WHERE 子句中执行 IN 操作（list，tuple）的问题"/>
  <meta property="og:site_name" content="别院牧志"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.ico" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/journal.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  
    <script src="/js/marked.js"></script>
    <script src="/js/comment.js"></script>
    <script src="/js/timeago.min.js"></script>
    <script src="/js/highlight.min.js"></script>
	<script src="/js/spin.min.js"></script>
  
  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar  navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">别院牧志</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>归档
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于我
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header ">		
			<h1 class="title "> 关于在 Python 中 MySQL 的 WHERE 子句中执行 IN 操作（list，tuple）的问题</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">
	  		

	  <script src="/assets/js/APlayer.min.js"> </script><p>今天在写代码的时候，有一处查询语句需要执行 <code>IN</code> 操作，结果直接<code>join</code>操作会出错。<br><a id="more"></a></p>
<pre><code class="Python">list_of_datas = [u&#39;sde&#39;, u&#39;sdf&#39;, u&#39;sdb&#39;, u&#39;sdc&#39;]
sql = &quot;SELECT DiskId,Name,Sg,PhyId,ExpanderId,EProduct FROM Disk WHERE Used=&#39;2&#39; AND Name IN (%s)&quot; % &#39;,&#39;.join(list_of_datas)
</code></pre>
<p>执行结果：</p>
<pre><code class="SQL">SELECT DiskId, Name, Sg, PhyId, ExpanderId
    , EProduct
FROM Disk
WHERE Used = &#39;2&#39;
    AND Name IN (sde, sdf, sdb, sdc)
</code></pre>
<p>很明显与预期的结果是不一样的。因为 <code>IN</code> 操作中的选取字段应该是带引号的字符串，而不是直接显示的字符串。也就是说我们期望的<code>WHERE</code>子句中是<code>WHERE Used = &#39;2&#39; AND Name IN (&#39;sde&#39;, &#39;sdf&#39;, &#39;sdb&#39;, &#39;sdc&#39;)</code>形式。</p>
<pre><code class="Python">sql1 = &quot;SELECT DiskId,Name,Sg,PhyId,ExpanderId,EProduct FROM Disk WHERE Used=&#39;2&#39; AND Name IN (%s)&quot; % &#39;,&#39;.join([&quot;&#39;%s&#39;&quot; % item for item in list_of_datas])
</code></pre>
<p>执行结果：</p>
<pre><code class="SQL">SELECT DiskId, Name, Sg, PhyId, ExpanderId
    , EProduct
FROM Disk
WHERE Used = &#39;2&#39;
    AND Name IN (&#39;sde&#39;, &#39;sdf&#39;, &#39;sdb&#39;, &#39;sdc&#39;)
</code></pre>
<p>至此，可以满足我们的要求。不过，由于上面字符化操作感觉有点暴力，我们可以稍微改进一下：</p>
<pre><code class="Python">format_strings= &#39;,&#39;.join([repr(item) for item in list_of_datas])
print(format_strings)
</code></pre>
<p>执行结果：</p>
<pre><code class="Python">u&#39;sde&#39;,u&#39;sdf&#39;,u&#39;sdb&#39;,u&#39;sdc&#39;
</code></pre>
<p>此时 <code>SQL</code> 语句变成:</p>
<pre><code class="SQL">SELECT DiskId,Name,Sg,PhyId,ExpanderId,EProduct FROM Disk WHERE Used=&#39;2&#39; AND Name IN (u&#39;sde&#39;,u&#39;sdf&#39;,u&#39;sdb&#39;,u&#39;sdc&#39;)
</code></pre>
<p>这个是没办法正常查询出结果的，因为查询字段是 <code>unicode</code> 编码。</p>
<pre><code class="Python">format_unicode_strings = &#39;,&#39;.join([repr(item.encode(&#39;utf-8&#39;)) if isinstance(item,unicode) else repr(item) for item in list_of_datas])
</code></pre>
<p>此时结果满足我们的要求：</p>
<pre><code class="SQL">SELECT DiskId, Name, Sg, PhyId, ExpanderId
    , EProduct
FROM Disk
WHERE Used = &#39;2&#39;
    AND Name IN (&#39;sde&#39;, &#39;sdf&#39;, &#39;sdb&#39;, &#39;sdc&#39;)
</code></pre>
<p>至此，收工。</p>
<p>因为公司的代码封装函数是只能执行真正的 <code>SQL</code> 语句的，所以只能用上面的方法，查询网络上别人的解决方案发现下面的写法，以备参考。</p>
<pre><code class="Python">&gt;&gt;&gt; alist = [&#39;1.1.1.1&#39;,&#39;2.2.2.2&#39;,&#39;3.3.3.3&#39;]                                                    
&gt;&gt;&gt; select_str = &#39;select * from server where ip in (%s)&#39; % &#39;,&#39;.join([&#39;%s&#39;] * len(alist))       
&gt;&gt;&gt; select_str  
&#39;select * from server where ip in (%s,%s,%s)&#39; 
 # 执行sql查询
cursor.execute(select_str,a)
</code></pre>
<p>后面的写法有很多种，比如：</p>
<pre><code class="Python">args = [1, 2, 3]
in_p = &#39;, &#39;.join((map(lambda x: &#39;%s&#39;, args)))
realsql = sql % in_p
cursor.execute(realsql, args)
</code></pre>
<p>再比如：</p>
<pre><code class="Python">args = [1, 2, 3]
in_p = &#39;, &#39;.join(itertools.repeat(&#39;%s&#39;, len(args)))
cursor.execute(sql % in_p, args)
</code></pre>
<p>完整示例代码:</p>
<pre><code class="Python">#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Created by imoyao at 2018/5/18 17:17
import itertools
import MySQLdb


def excute_sql(sql):
    db = MySQLdb.connect(host=&quot;localhost&quot;, user=&quot;imoyao&quot;, passwd=&quot;111111&quot;, db=&quot;ODSP&quot;, charset=&quot;utf8&quot;)
    cr = db.cursor()
    cr.execute(sql)
    data = cr.fetchall()
    cr.close()
    db.close()
    return data


def excute_sql_datas(sqlstr, tupledata):
    db = MySQLdb.connect(host=&quot;localhost&quot;, user=&quot;imoyao&quot;, passwd=&quot;111111&quot;, db=&quot;ODSP&quot;, charset=&quot;utf8&quot;)
    cr = db.cursor()
    cr.execute(sqlstr,tupledata)
    data = cr.fetchall()
    cr.close()
    db.close()
    return data


if __name__ == &#39;__main__&#39;:
    list_of_datas = [u&#39;sde&#39;, u&#39;sdf&#39;, u&#39;sdb&#39;, u&#39;sdc&#39;]
    format_strings = &#39;,&#39;.join(
        [repr(item.encode(&#39;utf-8&#39;)) if isinstance(item, unicode) else repr(item) for item in list_of_datas])
    sql = &quot;SELECT DiskId,Name,Sg,PhyId,ExpanderId,EProduct FROM Disk WHERE Used=&#39;2&#39; AND Name IN (%s)&quot; % format_strings
    print(excute_sql(sql))

    print(&#39;*&#39;*40)

    sql2 = &quot;SELECT DiskId,Name,Sg,PhyId,ExpanderId,EProduct FROM Disk WHERE Used=&#39;2&#39; AND Name IN (%s)&quot;
    # format_strings2 = &#39;, &#39;.join(map(lambda x: &#39;%s&#39;, list_of_datas))
    # format_strings2 = &#39;, &#39;.join([&#39;%s&#39;] * len(list_of_datas))
    format_strings2 = &#39;, &#39;.join(itertools.repeat(&#39;%s&#39;, len(list_of_datas)))
    sqlstr = sql2 % format_strings2
    print(excute_sql_datas(sqlstr, list_of_datas))
</code></pre>
<p>参考链接：</p>
<ol>
<li><p><a href="https://blog.csdn.net/u011085172/article/details/79044490" target="_blank" rel="noopener">python mysql where in 对列表（list,,array）问题 - CSDN博客</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/4574609/executing-select-where-in-using-mysqldb" target="_blank" rel="noopener">python - Executing “SELECT … WHERE … IN …” using MySQLdb - Stack Overflow</a></p>
</li>
</ol>
	  
	</div>

	<!-- recommended posts -->
	

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/blog/2018-05-27/Split-Brain-Of-DRBD/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/blog/2018-04-28/the-underline-of-Python/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
        <a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a>
        <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
    </div>
    <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};
        with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>


        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>
    	 
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
           type: "github" ? "github" : "github",       
	       user: "imoyao",
	       repo: "imoyao.github.io",
		   client_id: "",
           client_secret: "",
		   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
		   go_to_comment: "去留言",
		   no_issue: "no_issue",
		   issue_title: "关于在 Python 中 MySQL 的 WHERE 子句中执行 IN 操作（list，tuple）的问题",
		   issue_id: "",
		   btn_class: "btn btn-primary",
		   comments_target: "#comment-thread",
		   loading_target: "#loading_spin"
		   });
	 </script>
  
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-05-10 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Python/">Python<span>11</span></a></li> <li><a href="/tags/MySQL/">MySQL<span>3</span></a></li> <li><a href="/tags/SQL/">SQL<span>1</span></a></li>
    </ul>
	</div>
	

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 imoyao
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#" style="text-align: center;line-height: 36px;">
  <i class="fa fa-chevron-up"></i>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->

  <script>
  marked.setOptions({
    highlight: function (code, lang) {
        return hljs.highlightAuto(code).value;
    }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
        if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
  </script>


</body>
   </html>
